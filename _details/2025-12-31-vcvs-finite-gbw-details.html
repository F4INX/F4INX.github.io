---
layout: post
title: Details of calculations for active bandpass filter with finite GBW operational amplifier.
permalink: /posts/vcvs-finite-gbw-details.html
last_modified_at: 2025-12-31
---

<!-- FIXME: Move globally -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<!-- FIXME: move globally -->
<style>
  .vcvs-finite-gbw-details .MathJax {
    font-size: 1.0em !important;
  }
</style>

<div class="vcvs-finite-gbw-details,no-js">
    <script>
        // Remove no-js class if JavaScript is enabled
        document.body.classList.remove('no-js');
    </script>

    <p class="begin-note">Many thanks to Christophe Basso to have showed me the factorisation technique which is the key of this work.</p>

    <h2>Introduction</h2>

    <p>Active operational amplifier filters, called VCVS in the jargon, are a convenient way to implement low frequency filtering, particularly when operational amplifiers are already used for amplification.</p>

    <p>Design equations are readily available but often don't take into account the needed correction for finite GBW of the operational amplifier.</p>

    <p>Texas Instruments <a href="https://www.ti.com/lit/an/sbaa236/sbaa236.pdf">SBAA236 application note</a> provides a compensation scheme using additional components, very efficient but overkill for lots of applications.</p>

    <p>This page presents simple equations for analysis and synthesis of VCVS filters with finite GBW operational amplifiers.</p>

    <h2>Transfer function</h2>

    <h3>Full expression</h3>

    <p><img src="{{ '/posts/vcvs-finite-gbw/schematic.svg' | relative_url }}"/></p>

    <p>Replace <latexinline>R_1</latexinline> and <latexinline>R_3</latexinline> by equivalent circuit: <latexinline>V_\text{TH} = V_\text{IN} \cdot \frac{R_3}{R_1 + R_3}</latexinline>, <latexinline>R_\text{TH} = \frac{R_1 \cdot R_3}{R_1 + R_3}</latexinline>.</p>

    <p>The voltage at point x, <latexinline>V_x</latexinline>, can be calculated using Millman theorem:</p>

    <latexmath>
    \begin{multline*}
    V_x = \frac{
        \frac{V_\text{TH}}{R_\text{TH}}+\frac{V^-}{\frac{1}{C \cdot s}}
        + \frac{V_\text{out}}{\frac{1}{C \cdot s}}
    }{
        \frac{1}{R_\text{TH}}
        + \frac{1}{\frac{1}{C \cdot s}}+\frac{1}{\frac{1}{C \cdot s}}
    }
    = \frac{
        \frac{1}{R_\text{TH}} \cdot V_\text{TH}
        + C \cdot s \cdot V^-
        + C \cdot s \cdot V_\text{out}
    }{
        \frac{1}{R_\text{TH}}
        + 2 \cdot C \cdot s
    } 
    \end{multline*}
    </latexmath>

    <p>The <latexinline>V^-</latexinline> voltage can be calculated in the same way:</p>

    <latexmath>
    \begin{multline*}
    V^- = \frac{
        \frac{V_x}{\frac{1}{C \cdot s}}
        + \frac{V_\text{out}}{R_2}
        }{
        \frac{1}{\frac{1}{C \cdot s}}
        + \frac{1}{R_2}
        }
    = \frac{
        C \cdot s \cdot V_x
        + \frac{1}{R_2} \cdot V_\text{out}
    }{
        C \cdot s
        + \frac{1}{R_2}
    }
    = \frac{
        R_2 \cdot C \cdot s \cdot V_x
        + V_\text{out}
    }{
        1 + R_2 \cdot C \cdot s
    } 
    \end{multline*}
    </latexmath>

    <div x-data="{ hide: true }">
        <a class="collapsible-link" @click="hide = !hide" x-text="!hide ? '[Hide details.]' : '[Show details.]'"></a>
        <div class="collapsible-content" :class="{ 'show': !hide }">

        <p>Combining both equations:</p>

        <latexmath>
        V^- = \frac{R_2 \cdot C \cdot s}{1 + R_2 \cdot C \cdot s} \cdot \left[
            \frac{
                \frac{1}{R_\text{TH}} \cdot V_\text{TH}
                + C \cdot s \cdot V^-
                + C \cdot s \cdot V_\text{out}
            }{
                \frac{1}{R_\text{TH}}
                + 2 \cdot C \cdot s
            }
        \right] + \frac{1}{1 + R_2 \cdot C \cdot s} \cdot V_\text{out}
        </latexmath>

        <p>Multiplying both sides of the equation by <latexinline>\left[ 1 + R_2 \cdot C \cdot s \right] \cdot \left[ \frac{1}{R_\text{TH}} + 2 \cdot C \cdot s \right]</latexinline>:</p>

        <latexmath>
        \left[ 1 + R_2 \cdot C \cdot s \right] \cdot \left[ \frac{1}{R_\text{TH}} + 2 \cdot C \cdot s \right] \cdot V^-
        = R_2 \cdot C \cdot s \cdot \left[
            \frac{1}{R_\text{TH}} \cdot V_\text{TH}
            + C \cdot s \cdot V^-
            + C \cdot s \cdot V_\text{out}
        \right]
        + \left[ \frac{1}{R_\text{TH}} + 2 \cdot C \cdot s \right] \cdot V_\text{out}
        </latexmath>

        <p>Multiplying by <latexinline>R_\text{TH}</latexinline> to outline the time constant units:</p>

        <latexmath>
        \left[ 1 + R_2 \cdot C \cdot s \right] \cdot \left[ 1 + 2 \cdot R_\text{TH} \cdot C \cdot s \right] \cdot V^-
        = R_2 \cdot C \cdot s \cdot \left[
            V_\text{TH}
            + R_\text{TH} \cdot C \cdot s \cdot V^-
            + R_\text{TH} \cdot C \cdot s \cdot V_\text{out}
        \right]
        + \left[ 1 + 2 \cdot R_\text{TH} \cdot C \cdot s \right] \cdot V_\text{out}
        </latexmath>

        <p>Developping and regrouping terms according to their voltage:</p>

        <latexmath>
            \begin{align*}
                &\left[
                1
                + \left(
                    2 \cdot R_\text{TH} \cdot C + R_2 \cdot C
                    \right) \cdot s
                + 2 \cdot R_\text{TH} \cdot R_2 \cdot C^2 \cdot s^2
                \right] \cdot V^-  \\
                & \quad =
                R_2 \cdot C \cdot s \cdot V_\text{TH}
                + R_\text{TH} \cdot R_2 \cdot C^2 \cdot s^2 \cdot V^-  \\
                & \qquad + \left[
                    1 + 2 \cdot R_\text{TH} \cdot C \cdot s + R_\text{TH} \cdot R_2 \cdot C^2 \cdot s^2
                \right] \cdot V_\text{out}
            \end{align*}
        </latexmath>

        <p>Regrouping V- on the left side (the change is put in bold for clarity):</p>

        <latexmath>
            \begin{align*}
                &\left[
                1
                + \left(
                    2 \cdot R_\text{TH} \cdot C + R_2 \cdot C
                    \right) \cdot s
                + \pmb{1} \cdot R_\text{TH} \cdot R_2 \cdot C^2 \cdot s^2
                \right] \cdot V^-  \\
                & \quad =
                R_2 \cdot C \cdot s \cdot V_\text{TH}
                + \left[
                    1 + 2 \cdot R_\text{TH} \cdot C \cdot s + R_\text{TH} \cdot R_2 \cdot C^2 \cdot s^2
                \right] \cdot V_\text{out}
            \end{align*}
        </latexmath>

        <p>Plugging op-amp gain (don’t forget the sign!):</p>

        <latexmath>
            \begin{align*}
                & - \left[
                1
                + \left(
                    2 \cdot R_\text{TH} \cdot C + R_2 \cdot C
                    \right) \cdot s
                + R_\text{TH} \cdot R_2 \cdot C^2 \cdot s^2
                \right] \cdot \frac{V_\text{out}}{\omega_\text{BW} \cdot s}  \\
                & \quad =
                R_2 \cdot C \cdot s \cdot V_\text{TH}
                + \left[
                    1 + 2 \cdot R_\text{TH} \cdot C \cdot s + R_\text{TH} \cdot R_2 \cdot C^2 \cdot s^2
                \right] \cdot V_\text{out}
            \end{align*}
        </latexmath>

        <p>Outlining the polynomial of s:</p>

        <latexmath>
            \begin{align*}
                & - \left[
                \frac{1}{\omega_\text{BW}} \cdot s
                + \frac{
                    2 \cdot R_\text{TH} \cdot C + R_2 \cdot C
                }{\omega_\text{BW}} \cdot s^2
                + \frac{R_\text{TH} \cdot R_2 \cdot C^2}{\omega_\text{BW}} \cdot s^3
                \right] \cdot V_\text{out}  \\
                & \qquad =
                R_2 \cdot C \cdot s \cdot V_\text{TH}
                + \left[
                    1 + 2 \cdot R_\text{TH} \cdot C \cdot s + R_\text{TH} \cdot R_2 \cdot C^2 \cdot s^2
                \right] \cdot V_\text{out}
            \end{align*}
        </latexmath>

        <p>Putting all the V_out on the left:</p>

        <latexmath>
            \begin{align*}
                & - \left[
                1
                + \left( \frac{1}{\omega_\text{BW}} + 2 \cdot R_\text{TH} \cdot C \right) \cdot s
                +  \left(
                        \frac{
                            2 \cdot R_\text{TH} \cdot C + R_2 \cdot C
                        }{\omega_\text{BW}}
                        + R_\text{TH} \cdot R_2 \cdot C^2
                    \right) \cdot s^2
                + \frac{R_\text{TH} \cdot R_2 \cdot C^2}{\omega_\text{BW}} \cdot s^3
                \right] \cdot V_\text{out}  \\
                & \qquad =
                R_2 \cdot C \cdot s \cdot V_\text{TH}
            \end{align*}
        </latexmath>

        <!-- <p>From which the transfer function can be calculated:</p> -->

        </div>  <!-- End of <div class="collapsible-content"> -->
    </div>  <!-- End of <div x-data="..."> -->

<!-- <p>The full transfer function is:</p> -->
<p>Leading after some math to the transfer function:</p>
    <latexmath>
        \begin{align*}
            V_\text{out} = \frac{
                - R_2 \cdot C \cdot s
            }{
                1
                + \left( \frac{1}{\omega_\text{BW}} + 2 \cdot R_\text{TH} \cdot C \right) \cdot s
                +  \left(
                        \frac{
                            2 \cdot R_\text{TH} \cdot C + R_2 \cdot C
                        }{\omega_\text{BW}}
                        + R_\text{TH} \cdot R_2 \cdot C^2
                    \right) \cdot s^2
                + \frac{R_\text{TH} \cdot R_2 \cdot C^2}{\omega_\text{BW}} \cdot s^3
            } \cdot V_\text{TH}
        \end{align*}
    </latexmath>

    <h3>Test expression with infinite GBW</h3>

    <p>When GBW infinite, the following expression reduces to:</p>

    <latexmath>
        \begin{align*}
            V_\text{out} = \frac{
                - R_2 \cdot C \cdot s
            }{
                1
                + 2 \cdot R_\text{TH} \cdot C \cdot s
                + R_\text{TH} \cdot R_2 \cdot C^2 \cdot s^2
            } \cdot V_\text{TH}
        \end{align*}
    </latexmath>

    <p></p>

    <div x-data="{ hide: true }">
        <a class="collapsible-link" @click="hide = !hide" x-text="!hide ? '[Hide details.]' : '[Show details.]'"></a>
        <div class="collapsible-content" :class="{ 'show': !hide }">

            <!-- FIXME: problem to return when section collapsed. -->
            <!-- Quick fix: remove the backlink. -->
            For an ideal VCVS filter with infinite GBW opamps<sup><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>:

            <latexmath>
                \begin{align*}
                    V_\text{out} = \frac{
                        \frac{A^{'}}{Q \cdot \omega_0} s
                    }{
                        1
                        + \frac{1}{Q \cdot \omega_0} \cdot s
                        + \frac{1}{\omega_0^2} \cdot s^2
                    } \cdot V_\text{TH}
                \end{align*}
            </latexmath>

            <p>Note this gain is called <latexinline>A^{'}</latexinline> and not <latexinline>A</latexinline> because it does not include the <latexinline>\frac{V_\text{TH}}{V_\text{in}}</latexinline>.</p>

            <latexmath>
                \begin{align*}
                    V_\text{out} &= \frac{
                        \frac{A^{'}}{Q \cdot \omega_0} s
                    }{
                        1
                        + \frac{1}{Q \cdot \omega_0} \cdot s
                        + \frac{1}{\omega_0^2} \cdot s^2
                    } \cdot V_\text{TH}  \\
                    &= \frac{
                        - R_2 \cdot C \cdot s
                    }{
                        1
                        + 2 \cdot R_\text{TH} \cdot C \cdot s
                        + R_\text{TH} \cdot R_2 \cdot C^2 \cdot s^2
                    } \cdot V_\text{TH}
                \end{align*}
            </latexmath>

            <p></p>

            <latexmath>
                \begin{align*}
                    \cases{
                        \frac{A^{'}}{Q \cdot \omega_0} = - R_2 \cdot C  \\
                        \frac{1}{Q \cdot \omega_0} = 2 \cdot R_\text{TH} \cdot C  \\
                        \frac{1}{\omega_0^2} = R_\text{TH} \cdot R_2 \cdot C^2
                    }
                \end{align*}
            </latexmath>

            <p><em>The ... are equations that will be filled in a future release of this page.</em></p>

            <latexmath>
                \left\{
                    \begin{align*}
                        & A^{'} = \frac{- R_2}{2 \cdot R_\text{TH}} \qquad A = \frac{R_3}{R_1+R_3} \cdot \frac{R_1+R_3}{R_1\cdot R_3} \cdot \frac{R_2}{2} = \frac{-R_2}{R_1} && \text{OK}  \\
                        & Q = \frac{1}{2 \cdot R_\text{TH} \cdot C\cdot \omega_0} = ... = \pi \cdot f_0 \cdot R_C \cdot C && \text{OK}  \\
                        & \omega_0 = ... \qquad f_0 = ... = \frac{1}{2 \cdot \pi \cdot C} \cdot \sqrt{\frac{R_1 + R_3}{R_1 \cdot R_2 \cdot R_3}} && \text{OK}
                    \end{align*}
                \right.
            </latexmath>
        </div>  <!-- End of <div class="collapsible-content"...> -->
    </div>  <!-- End of <div x-data="..."> -->

    <p>Which has the following parameters:</p>

    <latexmath>
        \left\{
            \begin{align*}
                & A = \frac{-R_2}{R_1} && \text{OK}  \\
                & Q = \pi \cdot f_0 \cdot R_C \cdot C && \text{OK}  \\
                & f_0 = \frac{1}{2 \cdot \pi \cdot C} \cdot \sqrt{\frac{R_1 + R_3}{R_1 \cdot R_2 \cdot R_3}} && \text{OK}
            \end{align*}
        \right.
    </latexmath>

    <p>Consistent with the equations for infinite GBW<sup id="fnref:2"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>.</p>

    <h3>Parameters for finite GBW</h3>

    <p>Since this VCVS has another pole due to the finite GBW of the opamps, the transfer function is as follows:</p>

    <latexmath>
        \begin{align*}
            V_\text{out} = \frac{
                \frac{A^{'}}{Q \cdot \omega_0} s
            }{
                \left[
                    1
                    + \frac{1}{Q \cdot \omega_0} \cdot s
                    + \frac{1}{\omega_0^2} \cdot s^2
                \right] \cdot
                \left[
                    1 + \frac{1}{\omega_p} \cdot s
                \right]
            } \cdot V_\text{TH}
        \end{align*}
    </latexmath>

    <p>Assuming the pole is far enough from the center frequency, its effect can be neglected, and the gain has still the same value:</p>

    <latexmath>
    \frac{A^{'}}{Q \cdot \omega_0} = - R_2 \cdot C; \qquad A^{'} = \frac{- R_2}{2 \cdot R_\text{TH}}
    </latexmath>

    <p>However, the denominator needs to be factorized before the other parameters can be expressed.</p>

    <h2>Factorisation</h2>

    <h3>Seeked factorisation</h3>

    <p>Coefficients of denominator:</p>

    <latexmath>
    D(s) = 1 + b_1 \cdot s + b_2 \cdot s^2 + b_3 \cdot s^3
    </latexmath>

    <p>Seek factorisation as such, using time constants instead of angular frequencies to make calculations easier:</p>

    <latexmath>
    \begin{align*}
    D(s) &= \left( 1 + \frac{\tau_0}{Q} \cdot s + \tau_0^2 \cdot s^2  \right) \cdot \left( 1 + \tau_p \cdot s \right)  \\
    D(s) &= 1 + \left( \frac{\tau_0}{Q} + \tau_p \right) \cdot s + \left( \tau_0^2 + \frac{\tau_0 \cdot \tau_p}{Q} \right) \cdot s^2 + \tau_0^2 \cdot \tau_p \cdot s^3
    \end{align*}
    </latexmath>

    <p>To allow solving, hypothesis <latexinline>\tau_0^2 \gg \frac{\tau_0 \cdot \tau_p}{Q}</latexinline>:</p>

    <latexmath>
        \cases{
            \tau_0^2 \cdot \tau_p = b_3  \\
            \tau_0^2 = b_2  \\
            \frac{\tau_0}{Q} + \tau_p = b_1
        }
    </latexmath>

    <p></p>

    <latexmath>
        \cases{
            \tau_p = \frac{b_3}{b_2}  \\
            \tau_0^2 = b_2  \\
            \frac{\tau_0}{Q} = b_1 - \frac{b_3}{b_2}
        }
    </latexmath>

    <p>Anticipating a simplification to come, these equations can be rewritten as follows:</p>

    <latexmath>
        \cases{
            \tau_p = \frac{b_3}{\tau_0^2}  \\
            \tau_0^2 = b_2  \\
            \frac{\tau_0}{Q} = b_1 - \frac{b_3}{\tau_0^2}
        }
    </latexmath>

    <h3>Applying to components values</h3>

    <p>Plugging components values:</p>

    <latexmath>
        D(s) = 1
                + \left( 2 \cdot R_\text{TH} \cdot C + \frac{1}{\omega_\text{BW}} \right) \cdot s
                +  \left(
                        R_\text{TH} \cdot R_2 \cdot C^2
                        + \frac{
                            2 \cdot R_\text{TH} \cdot C + R_2 \cdot C
                        }{\omega_\text{BW}}
                    \right) \cdot s^2
                + \frac{R_\text{TH} \cdot R_2 \cdot C^2}{\omega_\text{BW}} \cdot s^3
    </latexmath>

    <div x-data="{ hide: true }">
        <a class="collapsible-link" @click="hide = !hide" x-text="!hide ? '[Hide details.]' : '[Show details.]'"></a>
        <div class="collapsible-content" :class="{ 'show': !hide }">

            <latexmath>
                \cases{
                    \tau_p = \frac{R_\text{TH} \cdot R_2 \cdot C^2}{\omega_\text{BW} \cdot \tau_0^2}  \\
                    \tau_0^2 = R_\text{TH} \cdot R_2 \cdot C^2
                                + \frac{
                                    2 \cdot R_\text{TH} \cdot C + R_2 \cdot C
                                }{\omega_\text{BW}}  \\
                    \frac{\tau_0}{Q} = 2 \cdot R_\text{TH} \cdot C + \frac{1}{\omega_\text{BW}} - \frac{R_\text{TH} \cdot R_2 \cdot C^2}{\omega_\text{BW} \cdot \tau_0^2}
                }
            </latexmath>

            <p></p>

            <latexmath>
            \frac{1}{\omega_\text{BW}} - \frac{R_\text{TH} \cdot R_2 \cdot C^2}{\omega_\text{BW} \cdot \tau_0^2} =
            \frac{\tau_0^2 - R_\text{TH} \cdot R_2 \cdot C^2}{\omega_\text{BW} \cdot \tau_0^2} =
            \frac{2 \cdot R_\text{TH} \cdot C + R_2 \cdot C}{\omega_\text{BW}^2 \cdot \tau_0^2}
            </latexmath>

        </div>  <!-- End of <div class="collapsible-content"...> -->
    </div>  <!-- End of <div x-data="..."> -->

    Leads to:

    <latexmath>
        \cases{
            \tau_p = \frac{R_\text{TH} \cdot R_2 \cdot C^2}{\omega_\text{BW} \cdot \tau_0^2}  \\
            \tau_0^2 = R_\text{TH} \cdot R_2 \cdot C^2
                        + \frac{
                            2 \cdot R_\text{TH} \cdot C + R_2 \cdot C
                        }{\omega_\text{BW}}  \\
            \frac{\tau_0}{Q} = 2 \cdot R_\text{TH} \cdot C + \frac{2 \cdot R_\text{TH} \cdot C + R_2 \cdot C}{\omega_\text{BW}^2 \cdot \tau_0^2}
        }
    </latexmath>

    <h2>Synthesis formulas</h2>

    <p>First-order approximation:</p>

    <latexmath>
        \cases{
            \tau_0^2 = R_\text{TH} \cdot R_2 \cdot C^2
                        + \frac{
                            2 \cdot R_\text{TH} \cdot C + R_2 \cdot C
                        }{\omega_\text{BW}}  \\
            \frac{\tau_0}{Q} \approx 2 \cdot R_\text{TH} \cdot C
        }
    </latexmath>

    <div x-data="{ hide: true }">
        <a class="collapsible-link" @click="hide = !hide" x-text="!hide ? '[Hide details.]' : '[Show details.]'"></a>
        <div class="collapsible-content" :class="{ 'show': !hide }">

            <p>Next, second equation becomes:</p>

            <latexmath>
                R_\text{TH} \cdot C = \frac{\tau_0}{2 \cdot Q}
            </latexmath>

            <p>And first equation:</p>

            <latexmath>
                \begin{gather*}
                    R_\text{TH} \cdot R_2 \cdot C^2
                    = \tau_0^2
                        - \frac{
                            2 \cdot R_\text{TH} \cdot C + R_2 \cdot C
                        }{\omega_\text{BW}}
                    = \tau_0^2
                        - \frac{
                            2 \cdot R_\text{TH} \cdot C
                        }{\omega_\text{BW}}
                        - \frac{
                            R_2 \cdot C
                        }{\omega_\text{BW}}  \\
                    \frac{\tau_0}{2 \cdot Q} \cdot R_2 \cdot C
                    = \tau_0^2
                        - \frac{2}{\omega_\text{BW}} \cdot \frac{\tau_0}{2 \cdot Q}
                        - \frac{
                            R_2 \cdot C
                        }{\omega_\text{BW}}  \\
                    \left[ \frac{\tau_0}{2 \cdot Q} + \frac{1}{\omega_\text{BW}} \right] \cdot R_2 \cdot C = \tau_0 \cdot \left[ 1 - \frac{1}{Q \cdot \omega_\text{BW} \cdot \tau_0} \right]
                \end{gather*}
            </latexmath>

            <p>Rewriting to highlight the infinite GBW value and the correction term:</p>

            <latexmath>
                \begin{gather*}
                    \frac{\tau_0}{2 \cdot Q} \cdot \left[ 1 + \frac{2 \cdot Q}{\omega_\text{BW} \cdot \tau_0} \right] \cdot R_2 \cdot C = \tau_0 \cdot \left[ 1 - \frac{1}{Q \cdot \omega_\text{BW} \cdot \tau_0} \right]  \\
                    R_2 \cdot C = \left. 2 \cdot Q \cdot \tau_0 \cdot \left[ 1 - \frac{1}{Q \cdot \omega_\text{BW} \cdot \tau_0} \right] \middle/ \left[ 1 + \frac{2 \cdot Q}{\omega_\text{BW} \cdot \tau_0} \right]\right.
                \end{gather*}
            </latexmath>

            <p>A previous version of this article presented a further first order approximation of this equation using the hypothesis <latexinline>\frac{2 \cdot Q}{\omega_\text{BW} \cdot \tau_0} \ll 1</latexinline>. This hypothesis is <strong>inaccurate</strong> in though cases, like the example to come using an LM324, and bring no additional value. Sorry for the inconvenience.</p>

            <p>Gathering all pieces:</p>

            <latexmath>
                \cases{
                    R_2 \cdot C = \left. 2 \cdot Q \cdot \tau_0 \cdot \left[ 1 - \frac{1}{Q \cdot \omega_\text{BW} \cdot \tau_0} \right] \middle/ \left[ 1 + \frac{2 \cdot Q}{\omega_\text{BW} \cdot \tau_0} \right]\right.  \\
                    R_\text{TH} \cdot C = \frac{\tau_0}{2 \cdot Q}
                }
            </latexmath>

        </div>  <!-- End of <div class="collapsible-content"...> -->

        <div class="collapsible-content-aux" :class="{ 'show': hide }">

            <p>After some math:</p>

        </div>
    </div>  <!-- End of <div x-data="..."> -->

    <latexmath>
        \cases{
            R_2 = \left. \frac{2 \cdot Q \cdot \tau_0}{C} \cdot \left[ 1 - \frac{1}{Q \cdot \omega_\text{BW} \cdot \tau_0} \right] \middle/ \left[ 1 + \frac{2 \cdot Q}{\omega_\text{BW} \cdot \tau_0} \right]\right.  \\
            R_\text{TH} = \frac{\tau_0}{2 \cdot Q \cdot C}
        }
    </latexmath>

    <h3>Parasitic pole equation</h3>

    <p>One the components values are calculated, the parasitic pole frequency can be calculated as follows:</p>

    <!-- TODO: cleanup the equations -->
    <latexmath>
        \tau_p = \frac{R_\text{TH} \cdot R_2 \cdot C^2}{\omega_\text{BW} \cdot \tau_0^2}
    </latexmath>

    <p></p>

    <div x-data="{ hide: true }">
        <a class="collapsible-link" @click="hide = !hide" x-text="!hide ? '[Hide details.]' : '[Show details.]'"></a>
        <div class="collapsible-content" :class="{ 'show': !hide }">

        <!-- TODO: cleanup the equations -->
        <latexmath>
            \begin{gather*}
                R_2
                = \left. \frac{2 \cdot Q \cdot \tau_0}{C} \cdot \left[ 1 - \frac{1}{Q \cdot \omega_\text{BW} \cdot \tau_0} \right] \middle/ \left[ 1 + \frac{2 \cdot Q}{\omega_\text{BW} \cdot \tau_0} \right]\right.  \\
                \qquad = \left. \frac{1}{\pi \cdot \text{BW} \cdot C} \cdot \left[ 1 - \frac{\text{BW}}{\text{GBW}} \right] \middle/ \left[ 1 + \frac{2 f_0^2}{\text{BW} \cdot \text{GBW}} \right]\right.  \\
                R_\text{TH} = \frac{\tau_0}{2 \cdot Q \cdot C} = \frac{\text{BW}}{4 \cdot \pi \cdot f_0^2 \cdot C}  \\
                R_\text{TH} \cdot R_2 = \left.
                    \frac{1}{4 \cdot \pi^2 \cdot f_0^2 \cdot C^2} \cdot
                    \left[ 1 - \frac{\text{BW}}{\text{GBW}} \right]
                    \middle/
                    \left[ 1 + \frac{2 f_0^2}{\text{BW} \cdot \text{GBW}} \right]
                    \right.  \\
                \tau_p = \left.
                    \frac{1}{\omega_\text{BW}} \cdot
                    \left[ 1 - \frac{\text{BW}}{\text{GBW}} \right]
                    \middle/
                    \left[ 1 + \frac{2 f_0^2}{\text{BW} \cdot \text{GBW}} \right]
                    \right.
            \end{gather*}
        </latexmath>

        </div>  <!-- End of <div class="collapsible-content"...> -->

        <div class="collapsible-content-aux" :class="{ 'show': hide }">

            <p>After some math:</p>

        </div>
    </div>  <!-- End of <div x-data="..."> -->

    <latexmath>
        f_p = \left.
            \text{GBW} \cdot
            \left[ 1 + \frac{2 f_0^2}{\text{BW} \cdot \text{GBW}} \right]
            \middle/
            \left[ 1 - \frac{\text{BW}}{\text{GBW}} \right]
            \right.
    </latexmath>

    <h3>Conditions for realisability</h3>

    <p>The previously done hypothesis allows to calculate the needed values of the components. However, they are not necessarily realisable, for instance when the equations give negative values. The conditions for realisability are as follows:</p>

    <latexmath>
        \cases{
            R_2 = \left. \frac{2 \cdot Q \cdot \tau_0}{C} \cdot \left[ 1 - \frac{1}{Q \cdot \omega_\text{BW} \cdot \tau_0} \right] \middle/ \left[ 1 + \frac{2 \cdot Q}{\omega_\text{BW} \cdot \tau_0} \right]\right. \geq 0 \\
            R_\text{TH} = \frac{\tau_0}{2 \cdot Q \cdot C} \geq 0
        }
    </latexmath>

    <p>The second equation is always true. The first reduces to the following condition:</p>

    <latexmath>
        \begin{gather*}
            1 - \frac{1}{Q \cdot \omega_\text{BW} \cdot \tau_0}  \geq 0
        \end{gather*}
    </latexmath>

    <p>Leading to this condition:</p>

    <latexmath>
        \omega_\text{BW} \geq \frac{Q}{\tau_0}
    </latexmath>

    </p>Which can be interpreted as the gain-bandwidth of the operational amplifier must be higher than the filter frequency multiplied by a factor depending of the quality factor Q.</p>

    <h3>Hypothesis verification</h3>

    <h4>Factorosation hypothesis</h4>

    <p>Remind the hypothesis:</p>

    <latexmath>
    \tau_0^2 \gg \frac{\tau_0 \cdot \tau_p}{Q}
    </latexmath>

    <p>Equivalent to:</p>

    <latexmath>
    \frac{\tau_p}{Q \cdot \tau_0} \ll 1
    </latexmath>

    <p>It is difficult to have an exact expression for τ_p, but a bound allows to check the hypothesis:</p>

    <latexmath>
    \tau_p
    = \frac{R_\text{TH} \cdot R_2 \cdot C^2}{\tau_0^2 \cdot \omega_\text{BW}}
    = \frac{\tau_0^2 - \frac{2 \cdot R_\text{TH} \cdot C + R_2 \cdot C}{\omega_\text{BW}}}{\tau_0^2 \cdot \omega_\text{BW}}
    < \frac{\tau_0^2}{\tau_0^2 \cdot \omega_\text{BW}}
    = \frac{1}{\omega_\text{BW}}
    </latexmath>

    <p></p>

    <latexmath>
    \frac{\tau_p}{Q \cdot \tau_0} < \frac{1}{Q \cdot \omega_\text{BW} \cdot \tau_0}
    </latexmath>

    <p>So, a sufficient condition to satisfy the hypothesis is:</p>

    <latexmath>
    \frac{1}{Q \cdot \omega_\text{BW} \cdot \tau_0} \ll 1
    </latexmath>

    <p>This condition is similar to the realisability condition, albeit with some margin to take.</p>

    <h4>Circuit simplification hypothesis</h4>

    <p>Remind the hypothesis:</p>

    <latexmath>
    2 \cdot R_\text{TH} \cdot C \gg \frac{2 \cdot R_\text{TH} \cdot C + R_2 \cdot C}{\omega_\text{BW}^2 \cdot \tau_0^2}
    </latexmath>

    <p>Equivalent to:</p>

    <latexmath>
    \left( 1 + \frac{R_2}{R_\text{TH}} \right) \cdot \left(\frac{f_0}{\text{GBW}}\right)^2 \ll 1
    </latexmath>

    <!-- FIXME: add details because this is the section of details. -->
    <p>Although a formal check should be done, this condition is likely be largely true in most cases due to the squarring of the small term.</p>

    <latexmath>
    \left(\frac{f_0}{\text{GBW}}\right)^2 \leq Q \cdot \left(\frac{f_0}{\text{GBW}}\right)
    </latexmath>

    <h2>Example</h2>

    <p>In the project which gave me the opportunity to write this article, I simply used a 10 MHz GBW op-amp. However, to test GBW compensation equations, a lower GBW op-amp is a much better test. Indeed, it was this test which allows me to detect and fix a mistake in the previous version.</p>

    <p>JLCPCB offers a reduced price on the PCBAs using a reduced list of components. Components from <a href="https://jlcpcb.com/parts/1st/Amplifiers_Comparators_23">this list</a> are listed below:</p>

    <!-- FIXME: improve formatting. -->
    <ul>
        <li>NE5532DR &ensp;&ensp;&ensp;  output 2 V to Vcc - 2 V, not convenient for 5 V operation</li>
        <li>TL072CDT &ensp;&ensp;&ensp;   6 V min Vcc</li>
        <li>LM393DR2G &ensp;&ensp;        not an op-amp but a comparator</li>
        <li>OP07CDR &ensp;&ensp;&ensp;    6 V min Vcc</li>
        <li>LM358DR2G &ensp;&ensp;&ensp;  0 V to Vcc - 2 V, half LM324</li>
        <li>LM324DT &ensp;&ensp;&ensp;    0 V to Vcc - 2 V</li>
    </ul>

    <p>The LM324 is selected.</p>

    <p>Different values of its GBW are present in the various datasheets, but we'll stick to the most common value of 1.2 MHz.</p>

    <p>The following example filter was designed for a 40 kHz center frequency and a Q of 4 (10 kHz bandwidth). Schematic and simulation results are shown below:</p>

    <picture>
        <source srcset="{{ '/posts/vcvs-finite-gbw/vcvs-example-01.png' | relative_url }}" media="(prefers-color-scheme: light)"/>
        <source srcset="{{ '/posts/vcvs-finite-gbw/vcvs-example-01-dark.png' | relative_url }}" media="(prefers-color-scheme: dark)"/>
        <img src="{{ '/posts/vcvs-finite-gbw/vcvs-example-01.png' | relative_url }}" />
    </picture>

    <picture>
        <source srcset="{{ '/posts/vcvs-finite-gbw/vcvs-example-01-plot.png' | relative_url }}" media="(prefers-color-scheme: light)"/>
        <source srcset="{{ '/posts/vcvs-finite-gbw/vcvs-example-01-plot-dark.png' | relative_url }}" media="(prefers-color-scheme: dark)"/>
        <img src="{{ '/posts/vcvs-finite-gbw/vcvs-example-01-plot.png' | relative_url }}" />
    </picture>

    <p>As usual, files can be downloaded <a href="https://github.com/F4INX/F4INX.github.io/tree/master/posts/vcvs-finite-gbw">on my github repository</a>.</p>


    <div class="footnotes" role="doc-endnotes">
        <ol>
            <li id="fn:1"><p><a href="https://electronics.stackexchange.com/questions/735869/cannot-find-the-derivation-for-gain-and-q-in-a-mfb-bandpass-filter-with-fixed-ga">https://electronics.stackexchange.com/questions/735869/cannot-find-the-derivation-for-gain-and-q-in-a-mfb-bandpass-filter-with-fixed-ga</a><!-- FIXME: quick fix, see previous note. --><!-- <a href="#fnref:1" class="reversefootnote" role="doc-backlink">↩</a>--></p></li>
            <li id="fn:2"><p><a href="https://www.changpuak.ch/electronics/downloads/sloa088.pdf">https://www.changpuak.ch/electronics/downloads/sloa088.pdf</a> <a href="#fnref:2" class="reversefootnote" role="doc-backlink">↩</a></p></li>
        </ol>
    </div>

</div>  <!-- End of <div class="vcvs-finite-gbw-details, no-js"> -->
